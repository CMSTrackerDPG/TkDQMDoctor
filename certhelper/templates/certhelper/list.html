{% extends 'certhelper/base.html' %}
{% block title %}List{% endblock %}
{% load myfilters %}
{% load widget_tweaks %}

{% block content %}


    <h1 align="center">List of certified runs</h1>
    <div class="container" style="padding:0; margin:0; width:99%;">
        <div class="row">
            <div class="col col-sm-6">
                {% if not user.is_authenticated %}
                    <!-- Dont show any buttons if the user is not logged in -->
                {% else %}
                    <a href="{% url 'certhelper:create' %}" type="button" class="btn btn-link"><span
                            class="glyphicon glyphicon-plus-sign"></span> Add Run</a>
                    <a href="{% url 'certhelper:summary' %}{{ filter_parameters }}" type="button"
                       class="btn btn-link"><span
                            class="glyphicon glyphicon-list-alt"></span> Generate Summary</a>
                    <a href="{% url 'certhelper:references' %}" type="button" class="btn btn-link"><span
                            class="glyphicon glyphicon-pushpin"></span> List of reference runs</a>
                {% endif %}
            </div>
            <div class="col col-sm-6 text-right">
                {% if user.is_staff %}
                    <a href="{% url 'admin:index' %} " type="button" class="btn btn-link"><span
                            class="glyphicon glyphicon-cog"></span> Admin Settings</a>
                {% endif %}

                <a href="{% url 'certhelper:help' %}" type="button" class="btn btn-link"><span
                        class="glyphicon glyphicon-question-sign"></span> Help</a>
                {% if not user.is_authenticated %}
                    {% load socialaccount %}
                    <a href="/accounts/login" type="button"
                       class="btn btn-link"><span
                            class="glyphicon glyphicon-user"></span> Login</a>
                {% else %}
                    <a href="{% url 'certhelper:logout' %}" type="button" class="btn btn-link"><span
                            class="glyphicon glyphicon-off"></span> Logout {{ request.user.username }}</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="container">
        <div class="well" style="margin: 0 auto 10px; width: 800px;">
            <form class="form-inline" method="get">
                <div class="row">
                    <div class="col col-sm-2 vcenter text-right">
                        <strong>Date:</strong>
                    </div><div class="col col-sm-10 vcenter text-left">
                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-default active">
                            <input type="radio" name="options" id="radio_day" autocomplete="off" checked> Day
                        </label>
                        <label class="btn btn-default">
                            <input type="radio" name="options" id="radio_range" autocomplete="off"> Range
                        </label>
                    </div>
                    <span id="date_day">
                            <button type="button" class="btn btn-default" onclick="setFilterDateToAll()">All</button>
                            <button type="button" class="btn btn-default" onclick="setFilterDateToToday()">Today</button>
                            {% render_field filter.form.date %}
                        </span>

                    <span id="date_range" style="display: none;">
                            {% render_field filter.form.date_range %}
                        </span>

                    <span id="filter-button-top">
                        <button type="submit" class="btn btn-primary">
                            <span class="glyphicon glyphicon-filter"></span> Filter
                        </button>
                    </span>
                </div>
                </div>

                <div id="more" class="collapse">
                    <div class="row top-buffer">
                        <div class="col col-sm-2 vcenter text-right">
                            <strong>Category:</strong>
                        </div><div class="col col-sm-10 vcenter text-left">
                            {% render_field filter.form.category|add_class:"form-control" %}
                            {% render_field filter.form.subcategory|add_class:"form-control" %}
                            {% render_field filter.form.subsubcategory|add_class:"form-control" %}
                        </div>
                    </div>
                    <div class="row top-buffer">
                        <div class="col col-sm-2 vcenter text-right">
                            <strong>Run numbers:</strong>
                        </div><div class="col col-sm-10 vcenter text-left">
                            {% render_field filter.form.runs %}
                        </div>
                    </div>

                    <div class="row top-buffer">
                        <div class="col col-sm-2 vcenter text-right">
                            <strong>Run type:</strong>
                        </div><div class="col col-sm-10 vcenter text-left">
                        {% render_field filter.form.type %}
                    </div>
                    </div>
                </div>



                <div id="filter-button-bottom"  class="row top-buffer" style="display: none">
                    <div class="col col-sm-6 text-left">
                        <button type="button" class="btn btn-danger" id="clear-filters">
                            <span class="glyphicon glyphicon-remove"></span> Clear
                        </button>
                    </div>
                    <div class="col col-sm-6 text-right">
                        <button type="submit" class="btn btn-primary">
                            <span class="glyphicon glyphicon-filter"></span> Filter
                        </button>
                    </div>
                </div>

                <div class="row top-buffer" style="margin-bottom: -15px">
                    <div class="col col-sm-12 text-center">
                        <button type="button" id="show-filter-btn" class="btn btn-xs">
                            <span class="glyphicon glyphicon-menu-down"></span> Show More
                        </button>
                    </div>
                </div>

            </form>
        </div>


    </div>


    {% load render_table from django_tables2 %}
    {% render_table table %}
{% endblock %}

{% block style %}
    <style>

        .top-buffer {
            margin-top: 20px;
        }

        .date-checkbox {
            background: white;
            border-color: coral;
        }

        .date-checkbox:active {
            background: red;
        }

        .date-checkbox:hover {
            background: lightblue;
        }

        .vcenter {
            display: inline-block;
            vertical-align: middle;
            float: none;
        }

    </style>
{% endblock %}


{% block script %}
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <script>
        function setFilterDateToToday() {
            var today = new Date();
            var day = today.getDate();
            var month = today.getMonth() + 1;
            var year = today.getFullYear();
            document.getElementById("id_date_day").value = day;
            document.getElementById("id_date_month").value = month;
            document.getElementById("id_date_year").value = year;
        }

        function setFilterDateToAll() {
            document.getElementById("id_date_day").value = 0;
            document.getElementById("id_date_month").value = 0;
            document.getElementById("id_date_year").value = 0;
        }


        $(document).ready(function () {
            request_get_params= window.location.search.substr(1);

            //console.log("JA!!" + request_get_params)
            if(request_get_params.indexOf("runs") != -1 ||
            request_get_params.indexOf("type") != -1 || request_get_params.indexOf("category") != -1)
                $("#more").collapse('show');


            if(request_get_params.indexOf("date_range") != -1){
                //$("#radio_day").prop("checked", false);
                //$("#radio_range").prop("checked", true);
                $('#date_day').css('display', 'none');
                $('#date_range').css('display', 'inline');
            }

            if ($("#id_subcategory").val() == "") {
                $("#id_subcategory").hide()
                $("#id_subsubcategory").hide()
            }
            $("#id_category").change(function () {
                var category_id = $(this).val();  // get the selected category_id from the dropdown menu

                $.ajax({
                    url: "{% url 'certhelper:ajax_load_subcategories' %}",  // pass categoryId to load_subcategories view
                    data: {
                        'categoryid': category_id  // add the category_id to the GET parameters
                    },
                    success: function (data) {  // date is the return of the load_subcategories view function
                        $("#id_subcategory").html(data);  // replace dropdown options with with the data from load_subcategories view
                    }
                });
                $('#id_subcategory').val('').trigger('change');  //trigger a change in subcategory to also update subsubcategories

                if (category_id != "") {
                    $("#id_subcategory").show()
                } else {
                    $("#id_subcategory").hide()
                }
            });

            $("#id_subcategory").change(function () {
                var subcategory_id = $(this).val();

                $.ajax({
                    url: "{% url 'certhelper:ajax_load_subsubcategories' %}",
                    data: {
                        'subcategoryid': subcategory_id
                    },
                    success: function (data) {
                        $("#id_subsubcategory").html(data);
                    }
                });

                if (subcategory_id != "") {
                    $("#id_subsubcategory").show()
                } else {
                    $("#id_subsubcategory").hide()
                }
            });

            $("#show-filter-btn").click(function () {
                $("#more").collapse('toggle');
            });

            $("#clear-filters").click(function () {
                $('#id_date_range_0').val("");
                $('#id_date_range_1').val("");
                $('#id_date_day').val(0);
                $('#id_date_month').val(0);
                $('#id_date_year').val(0);
                $('#id_category').val("");
                $('#id_subcategory').val("");
                $('#id_subsubcategory').val("");
                $('#id_type').val("");
                $('#id_runs_0').val("");
                $('#id_runs_1').val("");
            });

            $("#radio_day").change(function () {
                $('#date_day').css('display', 'inline');
                $('#date_range').css('display', 'none');

                $('#id_date_range_0').val("");
                $('#id_date_range_1').val("");
            });


            $("#radio_range").change(function () {
                $('#date_day').css('display', 'none');
                $('#date_range').css('display', 'inline');

                document.getElementById("id_date_day").value = 0;
                document.getElementById("id_date_month").value = 0;
                document.getElementById("id_date_year").value = 0;
            });

            $("#more").on('show.bs.collapse', function () {
                $("#show-filter-btn").html('<span class=\"glyphicon glyphicon-menu-up\"></span> Show Less');
                $("#filter-button-bottom").css('display', 'inline');
                $("#filter-button-top").css('display', 'none');
            });
            $("#more").on('hide.bs.collapse', function () {
                $("#show-filter-btn").html('<span class=\"glyphicon glyphicon-menu-down\"></span> Show More');
                $("#filter-button-bottom").css('display', 'none');
                $("#filter-button-top").css('display', 'inline');
            });

            //remove empty attributes form URL
            $("form").submit(function () {
                $(this).find(":input").filter(function () {
                    return !this.value || this.value == "0";
                }).attr("disabled", "disabled");
                return true; // ensure form still submits
            });
        });
    </script>
{% endblock %}
