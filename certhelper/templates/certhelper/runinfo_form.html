{% extends 'certhelper/base.html' %}
{% block title %}List{% endblock %}

{% load widget_tweaks %}
{% load bootstrap3 %}
{% load form_tags %}
{% load static %}

{% block style %}
    <style>
        .add-type {
            color: green;
        }

        .problem_categories{
            overflow-y: scroll;
            height:200px;
        }

        .bottom-buffer {
            margin-bottom: 5px;
        }

        .checklist {
            margin-top: 5px;
        }

        /*
         * for the dynamic list of ref runs in
         *  drop-down menu based on selected type
         */
        select option[disabled] {
            display: none;
        }
    </style>
{% endblock style %}

{% block content %}
    <div class="container">
        <p>
            {% if form.errors %}
                {% for field in form %}
                    {% for error in field.errors %}
                        <div class="alert alert-danger">
                            <strong>{{ error|escape }}</strong>
                        </div>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <div class="alert alert-danger">
                        <strong>{{ error|escape }}</strong>
                    </div>
                {% endfor %}
            {% endif %}
        </p>

        <form class="well form-horizontal" method="POST" action="" id="id_runinfo_form">
            {% csrf_token %}
            {# TODO change title when editing Run #}
            <legend style="text-align: center;"><h1>Add new Run</h1></legend>

            {# Run type #}
            <div class="form-group">
                {# Checkboxes to filter Type (Collisions, Cosmics, Prompt, ... #}
                {% include 'certhelper/components/runinfo_form/runtype_checkboxes.html' %}

                <label class="col-sm-3 control-label" for="id_{{ form.type.name }}">
                    {{ form.type.label }}
                </label>
                <div class="col-sm-6">
                    <div class="input-group">
                        {% render_field form.type class="form-control" %}
                        <span class="input-group-btn">
                            {# TODO Add Type as modal instead of different page but with option as different page #}
                            <button class="btn btn-default"
                                    id="id_add_type"
                                    type="button"
                                    onclick="location.href='{% url 'certhelper:createtype' %}'">
                                <span class="glyphicon glyphicon-plus-sign add-type"></span> Add
                            </button>
                        </span>
                    </div>
                </div>
            </div>

            {# TODO add "Add Reference Run" button #}
            {# Reference run #}
            <div class="row">
                <div class="col-sm-offset-3 col-sm-6 bottom-buffer">
                    <div class="checkbox">
                        <label class="col-sm-6">
                            <input type="checkbox"
                                   name="match_type"
                                   id="id_match_type"
                                   checked> Match Type
                        </label>
                    </div>
                </div>
            </div>

            {# Reference run #}
            <div class="form-group">
                {% render_label_and_field_for form.reference_run %}
                <div class="col-sm-3"></div>
                <div class="col-sm-offset-3 col-sm-9 ">
                    <small class="form-text text-muted">
                        Can be taken from the <a href="https://twiki.cern.ch/twiki/bin/view/CMS/TrackerOfflineReferenceRuns" target="_blank">Tracker Offline Reference Runs List</a> twiki page
                    </small>
                </div>
            </div>

            {# Run number #}
            <div class="form-group">
                {% render_label_and_field_for form.run_number %}
                <div id="id_run_number_helptext" class="col-sm-3 help-block"></div>
                {% render_checklist_checkbox form.checklists.general not_required=checklist_not_required %}
            </div>

            {# Trackermap #}
            <div class="form-group">
                {% render_label_and_field_for form.trackermap %}
                {% render_checklist_checkbox form.checklists.trackermap not_required=checklist_not_required %}
            </div>

            {# Number of LS #}
            {% bootstrap_field form.number_of_ls field_class="col-sm-6" label_class="col-sm-3"%}

            {# Int. luminosity #}
            <div class="form-group">
                <label class="col-sm-3 control-label" for="id_int_luminosity">Int luminosity</label>
                <div class="col-sm-6">
                    <div class="input-group">
                        {% render_field form.int_luminosity class="form-control" %}
                        <span class="input-group-addon">pb<sup>-1</sup></span>
                    </div>
                </div>
                <div id="id_int_luminosity_helptext" class="col-sm-3 help-block"></div>
                <div class="col-sm-offset-3 col-sm-9 ">
                    <small class="form-text text-muted">
                        Can be taken from <a id="id_cmswbm_link" href="https://cmswbm.cern.ch/cmsdb/servlet/RunSummary" target="_blank">WBM Run Summary</a> under "Run Live Lumi"
                    </small>
                </div>
            </div>

            {# Pixel #}
            <div class="form-group">
                <label class="col-sm-3 control-label">{{ form.pixel.label }}</label>
                <div class="col-sm-6">
                    <div class="row bootstrap3-multi-input">
                        <div class="col-xs-10">
                            {% render_field form.pixel class="form-control" %}
                        </div>
                        <div class="col-xs-2 checkbox">
                            <label>
                                {% render_field form.pixel_lowstat class="form-check-input" %}
                                Lowstat
                            </label>
                        </div>
                    </div>
                </div>
                <div id="id_pixel_helptext" class="col-sm-3 help-block"></div>
                {% render_checklist_checkbox form.checklists.pixel not_required=checklist_not_required%}
            </div>

            {# SiStrip #}
            <div class="form-group">
                <label class="col-sm-3 control-label">{{ form.sistrip.label }}</label>
                <div class="col-sm-6">
                    <div class="row bootstrap3-multi-input">
                        <div class="col-xs-10">
                            {% render_field form.sistrip class="form-control" %}
                        </div>
                        <div class="col-xs-2 checkbox">
                            <label>
                                {% render_field form.sistrip_lowstat class="form-check-input" %}
                                Lowstat
                            </label>
                        </div>
                    </div>
                </div>
                <div id="id_sistrip_helptext" class="col-sm-3 help-block"></div>
                {% render_checklist_checkbox form.checklists.sistrip not_required=checklist_not_required%}
            </div>

            {# Tracking #}
            <div class="form-group">
                <label class="col-sm-3 control-label">{{ form.tracking.label }}</label>
                <div class="col-sm-6">
                    <div class="row bootstrap3-multi-input">
                        <div class="col-xs-10">
                            {% render_field form.tracking class="form-control" %}
                        </div>
                        <div class="col-xs-2 checkbox">
                            <label>
                                {% render_field form.tracking_lowstat class="form-check-input" %}
                                Lowstat
                            </label>
                        </div>
                    </div>
                </div>
                <div id="id_tracking_helptext" class="col-sm-3 help-block"></div>
                {% render_checklist_checkbox form.checklists.tracking not_required=checklist_not_required%}
            </div>

            {# Categories of Problems #}
            {% bootstrap_field form.problem_categories field_class="problem_categories col-sm-6" label_class="col-sm-3"%}

            {# Comments #}
            {% bootstrap_field form.comment field_class="col-sm-6" label_class="col-sm-3"%}

            {# Date #}
            {% bootstrap_field form.date field_class="col-sm-6" label_class="col-sm-3"%}

            {# Buttons #}
            {% include 'certhelper/components/runinfo_form/form_buttons.html' %}
        </form>
    </div>

    {% render_checklist_modal form.checklists.general %}
    {% render_checklist_modal form.checklists.trackermap %}
    {% render_checklist_modal form.checklists.pixel %}
    {% render_checklist_modal form.checklists.sistrip %}
    {% render_checklist_modal form.checklists.tracking %}
{% endblock %}


{% block script %}
    <script src="{% static "certhelper/js/runinfo_form.js" %}"></script>
    <script>
        $(document).ready(function () {
            /**
             * Popup Checklist modal with items when trying to check a checklist checkbox
             */
            $('[id^="id_checklist_"]').each(function() {
                popupChecklistModal($(this));
            });

            /**
             * Update Type-dropdown-list based on ticked checkboxes
             */
            $("[name='recotype'], [name='runtype'], #id_type").change(function(){
                filterTypeOptionsByCheckboxes();
            });

            /**
             * Update Reference-run-dropdown-list based on selected Type
             */
            $("#id_type, #id_match_type").change(function () {
                updateReferenceRunList()
            });

            /**
             * Update Reference-run-dropdown-list on page load
             */
            updateReferenceRunList();

            /**
             * Round the number of decimal places for int luminosity
             */
            let int_luminosity = $('#id_int_luminosity');
            int_luminosity.on('focusout',function(){
                if(int_luminosity.val() !== "") {
                    const rounded = parseFloat(int_luminosity.val()).toFixed(1);
                    int_luminosity.val(rounded);
                }
            });

            /**
             * Update the cmsbwm link in the help text for the int luminosity
             */
            let run_number = $('#id_run_number');
            run_number.on('input',function(){
                $('#id_cmswbm_link').attr("href", "https://cmswbm.cern.ch/cmsdb/servlet/RunSummary?RUN=" + $(this).val());
            });

            /**
             * Validate the run number
             */
            run_number.on('input',function(){
                validate_run_number();
            });

            function validate_run_number(){
                const run_number_text = run_number.val();
                const reference_run_number = get_selected_reference_run_number();
                if(run_number_text < 300000){
                    display_validation_error("run_number", "Run number is too low");
                } else if(run_number_text > 999999){
                    display_validation_error("run_number", "Run number is too high");
                } else if(Math.abs(reference_run_number - run_number_text) > 6000) {
                    const warning_text = "Run number seems odd. Please check";
                    display_validation_warning("run_number", warning_text);
                } else {
                    display_validation_success("run_number", "");
                }
            }

            /**
             * Validate the integrated luminosity
             */
            int_luminosity.on('input',function(){
                validate_int_luminosity();
            });

            function validate_int_luminosity(){
                const int_lumi = int_luminosity.val();
                let runtype = get_selected_runtype();
                if(runtype === "Cosmics" && int_lumi > 0){
                    const warning_text = "You certify a cosmics run. Are you sure about this value?";
                    display_validation_warning("int_luminosity", warning_text);
                } else {
                    display_validation_success("int_luminosity", "");
                }
            }

            /**
             * Remove green borders (from validation) when jumping to the next field
             */
            $("form :input").focusout(function(){
                $(".has-success").removeClass("has-success");
            });

            /**
             * Use the lowstat checkbox instead of the dropdown option
             * Lowstat choice is still available because of historic reasons.
             * This might be removed in future.
             */
            $('option[value="Lowstat"]').each(function () {
                if(!$(this).is(":selected")){
                    // Remove if not selected, to not break old certifications
                    $(this).remove();
                }
            });

            const components = "[name='pixel'], [name='sistrip'], [name='tracking']";
            /**
             * Disable lowstat checkbox when 'Excluded' is selected
             */
            $(components).change(function(){
                const component_id = $(this).attr('id');
                disable_lowstat_for_excluded_components(component_id);
                validate_tracking_component()
            });

            $("#id_type").change(function(){
                validate_tracking_component();
                validate_int_luminosity()
            });

            $("#id_reference_run").change(function(){
                validate_run_number();
            });



            /**
             * Disable lowstat checkboxes on page load where necessary
             */
            $(components).each(function(){
                const component_id = $(this).attr('id');
                disable_lowstat_for_excluded_components(component_id);
            });

            function disable_lowstat_for_excluded_components(component_id){
                const selector = "#" + component_id + " option:checked";
                const option = $(selector).val();
                const lowstat_selector = "#" + component_id + "_lowstat";
                if(option === "Excluded"){
                    $(lowstat_selector).prop('disabled', true);
                } else {
                    $(lowstat_selector).prop('disabled', false);
                }
            }

            function get_selected_type(){
                return $("#id_type").find(":selected")
            }

            function get_selected_runtype(){
                return get_selected_type().text().split(' ')[1]
            }

            function get_selected_reco(){
                return get_selected_type().text().split(' ')[0]
            }

            function get_selected_reference_run_number(){
                return $("#id_reference_run option:selected").text().split(' ')[0];
            }

            function get_selected_component_text(component_id){
                return  $("#" + component_id).find(":selected").text()
            }

            function clear_validation(field_name){
                let form_group = $("#id_" + field_name).closest(".form-group");
                form_group.removeClass("has-success");
                form_group.removeClass("has-warning");
                form_group.removeClass("has-error");
                form_group.find(".help-block").text("");
            }

            function set_help_block_text_and_class(field_name, error_text, css_class){
                let form_group = $("#id_" + field_name).closest(".form-group");
                let help_block = form_group.find(".help-block");
                form_group.removeClass("has-success");
                form_group.removeClass("has-warning");
                form_group.removeClass("has-error");
                form_group.addClass(css_class);
                help_block.text(error_text);
            }

            function display_validation_error(field_name, error_text){
                set_help_block_text_and_class(field_name, error_text, "has-error")
            }

            function display_validation_warning(field_name, error_text){
                set_help_block_text_and_class(field_name, error_text, "has-warning")
            }

            function display_validation_success(field_name, error_text){
                set_help_block_text_and_class(field_name, error_text, "has-success")
            }

            function validate_tracking_component(){
                const pixel = get_selected_component_text("id_pixel");
                const sistrip = get_selected_component_text("id_sistrip");
                const tracking = get_selected_component_text("id_tracking");
                const runtype = get_selected_runtype();

                if(sistrip === "Bad" && tracking === "Good"){
                    const error_text = "Tracking cant be good if SiStrip is Bad.";
                    display_validation_error("tracking", error_text)
                } else if(sistrip === "Excluded" && tracking === "Good"){
                    const error_text = "Tracking cant be good if SiStrip is Excluded.";
                    display_validation_error("tracking", error_text)
                } else if (runtype === "Collisions" && pixel === "Bad" && tracking === "Good"){
                    const error_text = "In Collisions Tracking cant be good if Pixel is Bad.";
                    display_validation_error("tracking", error_text)
                } else if (runtype === "Collisions" && pixel === "Excluded" && tracking === "Good"){
                    const error_text = "In Collisions Tracking cant be good if Pixel is Excluded.";
                    display_validation_error("tracking", error_text)
                } else {
                    clear_validation("tracking")
                }
            }
        });
    </script>
{% endblock script %}